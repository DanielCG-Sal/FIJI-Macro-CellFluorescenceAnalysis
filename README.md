# Image Analysis Pipeline Using Cellpose and FIJI

This protocol describes a semi-automated image analysis workflow for extracting quantitative data from microscopy images using segmentation masks generated by [Cellpose](https://www.cellpose.org/) and custom macros in FIJI/ImageJ. The pipeline enables robust cell-level and region-based quantifications across large image datasets, supporting batch processing and integration of ROIs.

---

## Overview

The workflow consists of the following main steps:

1. **Pre-processing and segmentation** of microscopy images using Cellpose.
2. **Creation of ROI sets** for region-based quantification using a custom ImageJ macro (`ROIcreator_SSJV.ijm`).
3. **Quantitative analysis** of Cellpose masks and image intensities using the macro `2D_CellposeMaskAnalyzer.ijm`.
4. **Output generation** in `.xls` format, including cell-level data and density calculations.

---

## Requirements

- [FIJI/ImageJ](https://imagej.net/software/fiji/) with [Bio-Formats](https://www.openmicroscopy.org/bio-formats/) plugin.
- [Cellpose](https://www.cellpose.org/) installed locally (Python environment recommended).
- Macros provided:
  - `ROIcreator_SSJV.ijm`
  - `2D_CellposeMaskAnalyzer.ijm`

---

## Folder Structure

The analysis expects the following directory structure inside a **general working folder**:

/GeneralFolder  
├── /Images ← Original microscopy images  
├── /Masks ← Segmentation masks from Cellpose (*.png)  
├── /ROIs  
│ ├── /Areas ← ROIs delimiting the area to analyse  
│ └── /Control ← ROIs for background measurement  

---

## Step 1: Cellpose Segmentation

Segment images using Cellpose (GUI or CLI). Save the resulting mask images as `.png` files with filenames ending in `_cp_masks.png`.

Ensure that the masks correspond exactly to the images to be analysed and are saved in the **Masks** folder.

---

## Step 2: ROI Creation in FIJI

Use the macro `ROIcreator_SSJV.ijm` to generate ROIs that define:

- **Area ROIs** (e.g., anatomical regions)
- **Negative control ROIs** (e.g., background)

The macro allows drawing, importing, and managing ROI sets. ROIs must be saved with the same name as the corresponding image (e.g., `image1.zip`) in their respective folders (`/Areas`, `/Control`).

---

## Step 3: Quantification Using 2D_CellposeMaskAnalyzer

Run the macro `2D_CellposeMaskAnalyzer.ijm` in FIJI to extract quantitative information from the segmented masks.

### Inputs

Upon execution, the macro prompts the user to:

1. Select the **general folder**.
2. Choose subfolders for:
   - Images
   - Masks
   - ROIs
3. Specify:
   - Channel to analyse (e.g., 1)
   - Pixel size (e.g., 1.86 px/μm)
4. Select folders for:
   - Area ROIs
   - Control ROIs

### Processing Steps

For each image:

- The image and its corresponding Cellpose mask are loaded.
- ROIs are extracted from the label image.
- Mean intensities and areas are measured per cell and per region.
- Background-corrected mean intensity is calculated.
- Summary and per-cell data are exported.

### Outputs

Two tables are generated:

- `PerCell.xls`: contains data per segmented object (cell), including:
  - Area
  - Raw mean intensity
  - Corrected mean intensity (background subtracted)
  - ROI ID and image info

- `Cell_count.xls`: summary per image, including:
  - Total number of segmented ROIs
  - Total area analysed
  - Density of objects (cells/μm²)

Both files are saved in the selected general folder.

---

## Notes

- The macro uses Bio-Formats to open images and masks. Ensure file formats are compatible.
- The pixel size must match that of the original acquisition.
- All files (images, masks, ROIs) must follow a consistent naming convention.

---

## Author

Developed by Jorge Valero, Ana Hernández García and Daniel Cañada García

---

## License

Both macros are released under the **GNU General Public License v3.0**. See [gpl-3.0.txt](https://www.gnu.org/licenses/gpl-3.0.txt) for details.

© 2023 Jorge Valero Gómez-Lobo

---

## Citation

If you use this workflow or any of the macros in your work, please cite:

> TBD
